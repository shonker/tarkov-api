#!/usr/bin/env php
<?php

// composer auto loader
require __DIR__ . '/../vendor/autoload.php';

use Monolog\Logger;
use Monolog\Handler\StreamHandler;
use TarkovAPI\Tarkov;

// Setup logging
$log = new Logger('tarkov.bin.app');
$log->pushHandler(new StreamHandler('php://stdout', Logger::DEBUG));

// Setup API
$api = new Tarkov();

//
// ----------------------------------------------------------------------
//

// Check if launcherVersion is up-to-date
#$log->info('launcher -> checkLauncherVersion');
#$api->launcher()->checkLauncherVersion();


// Check if gameVersion is up-to-date
#$log->info('launcher -> checkGameVersion');
#$api->launcher()->checkGameVersion();

// try get previous session
$session = file_get_contents(__DIR__ .'/session');

// if empty, start a new login
if (empty($session)) {
    // Login (get your creds however you want... file, json, hardcode..., whatever)
    $log->info('launcher -> login');
    
    $creds = json_decode(file_get_contents(__DIR__ .'/creds.json'));
    $login = $api->auth()->login($creds->email, $creds->password);

    // Exchange token
    $session = $api->auth()->exchangeAccessToken($login->getData()->access_token);

    // Saving my session token
    $session = $session->getData()->session;
    file_put_contents(__DIR__ .'/session', $session);
}

// Get Profiles
$profiles = $api->profile()->getProfiles($session);

file_put_contents(
    __DIR__ .'/data.json',
    json_encode($profiles->getData(), JSON_PRETTY_PRINT)
);
